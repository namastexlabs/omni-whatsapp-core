// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_CONNECTION_URI")
}

enum InstanceConnectionStatus {
  open
  close
  connecting
}

enum DeviceMessage {
  ios
  android
  web
  unknown
  desktop
}

model Instance {
  id                      String                   @id @default(cuid())
  name                    String                   @unique
  connectionStatus        InstanceConnectionStatus @default(open)
  ownerJid                String?
  profileName             String?
  profilePicUrl           String?
  integration             String?
  number                  String?
  businessId              String?
  token                   String?
  clientName              String?
  disconnectionReasonCode Int?
  disconnectionObject     Json?
  disconnectionAt         DateTime?
  createdAt               DateTime?                @default(now())
  updatedAt               DateTime?                @updatedAt
  Chat                    Chat[]
  Contact                 Contact[]
  Message                 Message[]
  Webhook                 Webhook?
  Label                   Label[]
  Proxy                   Proxy?
  Setting                 Setting?
  Rabbitmq                Rabbitmq?
  Nats                    Nats?
  Sqs                     Sqs?
  Kafka                   Kafka?
  Websocket               Websocket?
  Session                 Session?
  MessageUpdate           MessageUpdate[]
  Media                   Media[]
  Template                Template[]
  Pusher                  Pusher?
}

model Session {
  id        String   @id @default(cuid())
  sessionId String   @unique
  creds     String?
  createdAt DateTime @default(now())
  Instance  Instance @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

model Chat {
  id             String    @id @default(cuid())
  remoteJid      String
  name           String?
  labels         Json?
  createdAt      DateTime? @default(now())
  updatedAt      DateTime? @updatedAt
  Instance       Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId     String
  unreadMessages Int       @default(0)

  @@index([instanceId])
  @@index([remoteJid])
}

model Contact {
  id            String    @id @default(cuid())
  remoteJid     String
  pushName      String?
  profilePicUrl String?
  createdAt     DateTime? @default(now())
  updatedAt     DateTime? @updatedAt
  Instance      Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId    String

  @@unique([remoteJid, instanceId])
  @@index([remoteJid])
  @@index([instanceId])
}

model Message {
  id               String          @id @default(cuid())
  key              Json
  pushName         String?
  participant      String?
  messageType      String
  message          Json
  contextInfo      Json?
  source           DeviceMessage
  messageTimestamp Int
  Instance         Instance        @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId       String
  MessageUpdate    MessageUpdate[]
  Media            Media?
  webhookUrl       String?
  status           String?

  @@index([instanceId])
}

model MessageUpdate {
  id          String   @id @default(cuid())
  keyId       String
  remoteJid   String
  fromMe      Boolean
  participant String?
  pollUpdates Json?
  status      String
  Message     Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId   String
  Instance    Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId  String

  @@index([instanceId])
  @@index([messageId])
}

model Webhook {
  id              String    @id @default(cuid())
  url             String
  headers         Json?
  enabled         Boolean?  @default(true)
  events          Json?
  webhookByEvents Boolean?  @default(false)
  webhookBase64   Boolean?  @default(false)
  createdAt       DateTime? @default(now())
  updatedAt       DateTime  @updatedAt
  Instance        Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId      String    @unique

  @@index([instanceId])
}

model Label {
  id           String    @id @default(cuid())
  labelId      String?
  name         String
  color        String
  predefinedId String?
  createdAt    DateTime? @default(now())
  updatedAt    DateTime  @updatedAt
  Instance     Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId   String

  @@unique([labelId, instanceId])
}

model Proxy {
  id         String    @id @default(cuid())
  enabled    Boolean   @default(false)
  host       String
  port       String
  protocol   String
  username   String
  password   String
  createdAt  DateTime? @default(now())
  updatedAt  DateTime  @updatedAt
  Instance   Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId String    @unique
}

model Setting {
  id              String    @id @default(cuid())
  rejectCall      Boolean   @default(false)
  msgCall         String?
  groupsIgnore    Boolean   @default(false)
  alwaysOnline    Boolean   @default(false)
  readMessages    Boolean   @default(false)
  readStatus      Boolean   @default(false)
  syncFullHistory Boolean   @default(false)
  wavoipToken     String?
  createdAt       DateTime? @default(now())
  updatedAt       DateTime  @updatedAt
  Instance        Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId      String    @unique

  @@index([instanceId])
}

model Rabbitmq {
  id         String    @id @default(cuid())
  enabled    Boolean   @default(false)
  events     Json
  createdAt  DateTime? @default(now())
  updatedAt  DateTime  @updatedAt
  Instance   Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId String    @unique
}

model Nats {
  id         String    @id @default(cuid())
  enabled    Boolean   @default(false)
  events     Json
  createdAt  DateTime? @default(now())
  updatedAt  DateTime  @updatedAt
  Instance   Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId String    @unique
}

model Sqs {
  id         String    @id @default(cuid())
  enabled    Boolean   @default(false)
  events     Json
  createdAt  DateTime? @default(now())
  updatedAt  DateTime  @updatedAt
  Instance   Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId String    @unique
}

model Kafka {
  id         String    @id @default(cuid())
  enabled    Boolean   @default(false)
  events     Json
  createdAt  DateTime? @default(now())
  updatedAt  DateTime  @updatedAt
  Instance   Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId String    @unique
}

model Websocket {
  id         String    @id @default(cuid())
  enabled    Boolean   @default(false)
  events     Json
  createdAt  DateTime? @default(now())
  updatedAt  DateTime  @updatedAt
  Instance   Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId String    @unique
}

model Pusher {
  id         String    @id @default(cuid())
  enabled    Boolean   @default(false)
  appId      String
  key        String
  secret     String
  cluster    String
  useTLS     Boolean   @default(false)
  events     Json
  createdAt  DateTime? @default(now())
  updatedAt  DateTime  @updatedAt
  Instance   Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId String    @unique
}

model Media {
  id         String    @id @default(cuid())
  fileName   String
  type       String
  mimetype   String
  createdAt  DateTime? @default(now())
  Message    Message   @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId  String    @unique
  Instance   Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId String
}

model Template {
  id         String    @id @default(cuid())
  templateId String    @unique
  name       String    @unique
  template   Json
  webhookUrl String?
  createdAt  DateTime? @default(now())
  updatedAt  DateTime  @updatedAt
  Instance   Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId String
}

model IsOnWhatsapp {
  id         String   @id @default(cuid())
  remoteJid  String   @unique
  jidOptions String
  lid        String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}
